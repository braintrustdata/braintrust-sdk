name: Release Python SDK

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Commit SHA or tag to release"
        required: true
        type: choice
        options:
          - ${{ github.event.repository.default_branch }}
          - ${{ steps.get-tags.outputs.tags }}
          - ${{ steps.get-commits.outputs.commits }}

jobs:
  get-refs:
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.set-ref.outputs.ref }}
    steps:
      - name: Get tags
        id: get-tags
        run: |
          echo "tags=$(git tag | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT

      - name: Get recent commits
        id: get-commits
        run: |
          echo "commits=$(git log --pretty=format:'%H' -n 20 | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT

      - name: Set ref
        id: set-ref
        run: |
          echo "ref=${{ inputs.ref }}" >> $GITHUB_OUTPUT

  run-tests:
    needs: get-refs
    uses: ./.github/workflows/py.yaml
    with:
      ref: ${{ needs.get-refs.outputs.ref }}

  publish:
    needs: run-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.get-refs.outputs.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip setuptools build twine

      - name: Template git commit hash
        run: make template-version

      - name: Build wheel
        run: |
          python -m build --wheel ./py

      - name: Publish to TestPyPI
        run: |
          python -m twine upload --repository testpypi dist/*.whl
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_TOKEN }}
