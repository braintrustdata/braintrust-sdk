[settings]
experimental=true

[env]
_.file = ".env"

[tools]
node = "22"
temporal = "latest"
mise = "latest"

[hooks]
postinstall = "true"

[tasks.install]
description = "Install dependencies"
run = "pnpm install --ignore-workspace"

[tasks.reinstall]
description = "Prepare pnpm, reinstall deps, build integration and start server+worker for testing"
run = '''
corepack enable
corepack prepare pnpm@10 --activate
pnpm install
pnpm run build:integration
temporal server start-dev & sleep 1
pnpm run worker
'''

[tasks.server]
description = "Build integration, run temporal server and a worker (use multiple terminals to run more workers)"
run = "pnpm run build:integration && temporal server start-dev & sleep 1; pnpm run worker"

[tasks.workflow]
description = "Run workflow client"
run = "pnpm run client"

[tasks.stop]
description = "Stop temporal server and workers"
run = "pkill -f temporal || true; pkill -f src/worker.ts || true"

[tasks.kill]
description = "Force kill temporal server and workers"
run = '''
pkill -f 'examples/temporal.*ts-node' 2>/dev/null || true
pkill -f 'overmind.*temporal' 2>/dev/null || true
pkill -f 'temporal' 2>/dev/null || true
echo 'Server killed'
'''
